name: Build NeOS ISO

on:
  push:
    branches: [main]
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pacman -Sy --noconfirm archiso git wget erofs-utils grub

      - name: Prepare Build Config
        run: |
          cd "$GITHUB_WORKSPACE"
          cp /etc/pacman.conf "$GITHUB_WORKSPACE/pacman-build.conf"
          MIRRORLIST_PATH="$GITHUB_WORKSPACE/airootfs/etc/pacman.d/neos-mirrorlist"
          if ! grep -q "^[[:space:]]*Server" "$MIRRORLIST_PATH"; then
            echo "No active servers in $MIRRORLIST_PATH" >&2
            exit 1
          fi
          if ! grep -q "\[core\]" "$GITHUB_WORKSPACE/pacman-build.conf"; then
            {
              echo ""
              echo "# Arch Repositories (Local Build)"
              echo "[core]"
              echo "Include = $MIRRORLIST_PATH"
              echo ""
              echo "[extra]"
              echo "Include = $MIRRORLIST_PATH"
              echo ""
              echo "[multilib]"
              echo "Include = $MIRRORLIST_PATH"
            } >> "$GITHUB_WORKSPACE/pacman-build.conf"
          fi
          ls -la "$GITHUB_WORKSPACE/pacman-build.conf"

      - name: Build ISO
        run: |
          PROFILE_DIR="$GITHUB_WORKSPACE"
          PACMAN_CONF="$GITHUB_WORKSPACE/pacman-build.conf"
          WORK_DIR="$GITHUB_WORKSPACE/work"
          OUT_DIR="$GITHUB_WORKSPACE/out"
          echo "PROFILE_DIR=$PROFILE_DIR"
          echo "PACMAN_CONF=$PACMAN_CONF"
          if [ -z "$PROFILE_DIR" ]; then
            echo "PROFILE_DIR is empty" >&2
            exit 1
          fi
          if [ ! -f "$PACMAN_CONF" ]; then
            echo "Missing pacman config at $PACMAN_CONF" >&2
            exit 1
          fi
          if [ ! -f "$PROFILE_DIR/profiledef.sh" ]; then
            echo "Missing profiledef.sh in $PROFILE_DIR" >&2
            exit 1
          fi
          mkarchiso -v -C "$PACMAN_CONF" -w "$WORK_DIR" -o "$OUT_DIR" "$PROFILE_DIR"

      - name: Validate ISO
        run: |
          cd "$GITHUB_WORKSPACE"
          bash tests/verify_iso_grub.sh
          bash tests/verify_iso_smoketest.sh

      - name: Upload ISO to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: out/*.iso
