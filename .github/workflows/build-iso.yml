name: Build NeOS ISO

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: build-iso-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key 3056513887B78AEB
          pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
          # Use --overwrite to handle gcc-libs split into libgcc/libstdc++
          # Target specific library files to avoid masking other conflicts
          pacman -Sy --noconfirm --overwrite='/usr/lib/libgcc*' --overwrite='/usr/lib/libstdc++*' --overwrite='/usr/share/licenses/gcc-libs/*' archiso git wget squashfs-tools grub syslinux

      - name: Prepare Build Config
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          # Use the repository's pacman.conf which includes size optimizations (NoExtract)
          cp "$GITHUB_WORKSPACE/pacman.conf" "$GITHUB_WORKSPACE/pacman-build.conf"

          MIRRORLIST_PATH="$GITHUB_WORKSPACE/airootfs/etc/pacman.d/neos-mirrorlist"
          CHAOTIC_MIRRORLIST_PATH="$GITHUB_WORKSPACE/airootfs/etc/pacman.d/chaotic-mirrorlist"
          if ! grep -q "^[[:space:]]*Server" "$MIRRORLIST_PATH"; then
            echo "No active servers in $MIRRORLIST_PATH" >&2
            exit 1
          fi

          # Update the Include path for the local build environment
          # The repo pacman.conf points to /etc/pacman.d/neos-mirrorlist (inside ISO)
          # We need it to point to the actual file in the workspace for mkarchiso
          sed -i "s|/etc/pacman.d/neos-mirrorlist|$MIRRORLIST_PATH|g" "$GITHUB_WORKSPACE/pacman-build.conf"
          sed -i "s|/etc/pacman.d/chaotic-mirrorlist|$CHAOTIC_MIRRORLIST_PATH|g" "$GITHUB_WORKSPACE/pacman-build.conf"

          echo "Generated pacman-build.conf:"
          cat "$GITHUB_WORKSPACE/pacman-build.conf"

      - name: Build ISO
        run: |
          set -euo pipefail
          PROFILE_DIR="$GITHUB_WORKSPACE"
          PACMAN_CONF="$GITHUB_WORKSPACE/pacman-build.conf"
          WORK_DIR="$GITHUB_WORKSPACE/work"
          OUT_DIR="$GITHUB_WORKSPACE/out"
          echo "PROFILE_DIR=$PROFILE_DIR"
          echo "PACMAN_CONF=$PACMAN_CONF"
          if [ -z "$PROFILE_DIR" ]; then
            echo "PROFILE_DIR is empty" >&2
            exit 1
          fi
          if [ ! -f "$PACMAN_CONF" ]; then
            echo "Missing pacman config at $PACMAN_CONF" >&2
            exit 1
          fi
          if [ ! -f "$PROFILE_DIR/profiledef.sh" ]; then
            echo "Missing profiledef.sh in $PROFILE_DIR" >&2
            exit 1
          fi
          mkarchiso -v -C "$PACMAN_CONF" -w "$WORK_DIR" -o "$OUT_DIR" "$PROFILE_DIR"

      - name: Combine ISO parts if split
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE/out" || exit 1
          # Check if ISO was split into parts
          shopt -s nullglob
          parts=(neos-*.iso.part*)
          if [ ${#parts[@]} -gt 0 ]; then
            echo "Found ISO part files, combining them..."
            # Extract the base filename from the first part file
            base_name="${parts[0]%.part*}"
            echo "Combining into: $base_name"
            # Use sort -V for proper numeric ordering (part1, part2, ..., part10)
            printf '%s\n' "${parts[@]}" | sort -V | xargs cat > "$base_name"
            echo "Combined ISO created: $base_name"
            ls -lh "$base_name"
            # Remove the part files to keep only the combined ISO
            rm -f "${parts[@]}"
          else
            echo "No split ISO parts found, using existing ISO file"
          fi
          ls -lh

      - name: Validate ISO
        run: |
          cd "$GITHUB_WORKSPACE"
          bash tests/verify_iso_grub.sh
          bash tests/verify_iso_size.sh
          bash tests/verify_iso_smoketest.sh

      - name: Validate ISO Size
        if: github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          # Find the ISO file safely without relying on ls
          ISO_FILE=$(find out -maxdepth 1 -name "*.iso" -type f | head -1)
          if [ -z "$ISO_FILE" ]; then
             echo "❌ No ISO file found to validate"
             exit 1
          fi

          ISO_SIZE=$(stat -c%s "$ISO_FILE")
          # 1.9 GiB limit to provide a safety buffer for GitHub release upload (approx 2040 MB)
          MAX_SIZE=$((1945 * 1024 * 1024))  # ~1.9 GiB

          echo "ISO File: $ISO_FILE"
          echo "ISO Size: $ISO_SIZE bytes"
          echo "Max Size: $MAX_SIZE bytes (1.9 GiB)"

          if [ "$ISO_SIZE" -ge "$MAX_SIZE" ]; then
            echo "❌ ISO exceeds GitHub release limit (1.9 GiB safety buffer)!"
            exit 1
          else
            echo "✅ ISO size is within limits."
          fi

      - name: Prepare ISO for upload
        id: iso
        if: github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          # Find the ISO file safely without relying on ls
          ISO_FILE=$(find out -maxdepth 1 -name "*.iso" -type f | head -1)
          ISO_SIZE=$(stat -c%s "$ISO_FILE")
          echo "ISO size: $ISO_SIZE bytes"
          ls -lh out/

      - name: Generate release tag
        id: tag
        if: github.ref == 'refs/heads/main'
        run: echo "value=v$(date +%Y.%m.%d)-$(echo ${{ github.sha }} | cut -c1-7)" >> "$GITHUB_OUTPUT"

      - name: Upload ISO to Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          name: NeOS ${{ steps.tag.outputs.value }}
          generate_release_notes: true
          body: ${{ steps.iso.outputs.body || '' }}
          files: out/neos-*
