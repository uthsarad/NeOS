#!/usr/bin/env python3

import os
import subprocess

def log(msg):
    print(f"[NeOS Driver Manager] {msg}")

def run_command(cmd):
    try:
        # Sentinel: Security fix - removed shell=True, cmd must be a list
        return subprocess.check_output(cmd, stderr=subprocess.STDOUT).decode().strip()
    except subprocess.CalledProcessError:
        return ""

_LOADED_MODULES_CACHE = None

def get_loaded_modules(force_refresh=False):
    global _LOADED_MODULES_CACHE
    if _LOADED_MODULES_CACHE is None or force_refresh:
        _LOADED_MODULES_CACHE = set()
        # Optimization: Read /proc/modules directly to avoid fork/exec overhead
        try:
            with open("/proc/modules", "r") as f:
                for line in f:
                    parts = line.split()
                    if parts:
                        _LOADED_MODULES_CACHE.add(parts[0])
        except (FileNotFoundError, IOError):
            # Fallback to lsmod if /proc/modules is inaccessible
            mods = run_command(["/usr/bin/lsmod"])
            for line in mods.splitlines():
                parts = line.split()
                if parts and parts[0] != "Module": # Skip header
                    _LOADED_MODULES_CACHE.add(parts[0])
    return _LOADED_MODULES_CACHE

def probe_driver(module_name):
    # Try to load module and update cache
    # Sentinel: Security fix - use subprocess.run instead of os.system
    res = subprocess.run(["/usr/bin/modprobe", module_name], check=False).returncode
    global _LOADED_MODULES_CACHE
    if res == 0 and _LOADED_MODULES_CACHE is not None:
        _LOADED_MODULES_CACHE.add(module_name)
    return res

_PCI_DEVICES_CACHE = None

def get_all_pci_devices(force_refresh=False):
    global _PCI_DEVICES_CACHE
    if _PCI_DEVICES_CACHE is None or force_refresh:
        # lspci -mn output format: "slot" "class" "vendor" "device" ...
        output = run_command(["/usr/bin/lspci", "-mn"])
        _PCI_DEVICES_CACHE = []
        for line in output.splitlines():
            parts = line.split()
            if len(parts) >= 4:
                # format: "00:02.0" "0300" "8086" "1916" ...
                slot = parts[0].strip('"')
                cls = parts[1].strip('"')
                vendor = parts[2].strip('"')
                device = parts[3].strip('"')
                _PCI_DEVICES_CACHE.append({'slot': slot, 'vendor': vendor, 'device': device, 'class': cls})
    return _PCI_DEVICES_CACHE

def get_pci_controllers(class_prefixes=("03",)):
    # List all PCI controllers matching the class prefixes
    # âš¡ Bolt: Use cached device list to avoid repeated lspci calls
    all_devices = get_all_pci_devices()
    # Optimization: startswith accepts a tuple, no need for generator expression
    return [d for d in all_devices if d['class'].startswith(class_prefixes)]

def check_driver_loaded(module_name):
    # Check if module is loaded using cache
    return module_name in get_loaded_modules()

def manage_gpu_drivers():
    devices = get_pci_controllers(class_prefixes=("03",))
    if not devices:
        log("No GPU detected.")
        return

    for dev in devices:
        vendor = dev['vendor']
        log(f"Found GPU: Vendor {vendor}, Device {dev['device']}")

        # Intel (8086)
        if vendor == "8086":
            if not check_driver_loaded("i915") and not check_driver_loaded("xe"):
                log("Intel GPU detected but i915/xe not loaded.")
                # Try loading
                probe_driver("i915")

        # AMD (1002)
        elif vendor == "1002":
            if not check_driver_loaded("amdgpu"):
                log("AMD GPU detected but amdgpu not loaded.")
                # Try loading
                probe_driver("amdgpu")
                # Fallback
                if not check_driver_loaded("amdgpu"):
                    log("Retrying with radeon...")
                    probe_driver("radeon")
            else:
                log("AMD driver (amdgpu) is loaded.")

        # Nvidia (10de)
        elif vendor == "10de":
            if not check_driver_loaded("nvidia"):
                log("Nvidia GPU detected but nvidia proprietary driver not loaded.")
                res = probe_driver("nvidia")
                if res != 0:
                    log("Failed to load nvidia. Checking for nouveau (community)...")
                    if not check_driver_loaded("nouveau"):
                        probe_driver("nouveau")
            else:
                log("Nvidia driver is loaded.")

def manage_network_drivers():
    # Simple check for network interfaces
    # If no interface other than lo, try to find drivers
    output = run_command(["/usr/bin/ip", "link", "show"])
    # Improved check: count interfaces properly
    interfaces = [line for line in output.splitlines() if line[0].isdigit()]
    # If only loopback (usually index 1)
    if len(interfaces) <= 1:
        # Identify specific network controller via PCI ID
        devices = get_pci_controllers(class_prefixes=("02",))
        drivers_to_load = []

        for dev in devices:
            vendor = dev['vendor']
            cls = dev['class']

            # Realtek (10ec)
            if vendor == "10ec":
                drivers_to_load.append("r8169")
            # Intel (8086)
            elif vendor == "8086":
                if cls.startswith("0200"): # Ethernet
                    drivers_to_load.append("e1000e")
                elif cls.startswith("0280"): # Wireless
                    drivers_to_load.append("iwlwifi")
            # Broadcom (14e4)
            elif vendor == "14e4":
                if "brcmfmac" not in drivers_to_load: drivers_to_load.append("brcmfmac")
                if "wl" not in drivers_to_load: drivers_to_load.append("wl")
            # Atheros (168c)
            elif vendor == "168c":
                drivers_to_load.append("ath10k_pci")
                if "ath9k" not in drivers_to_load: drivers_to_load.append("ath9k")

        if drivers_to_load:
            log(f"No network interfaces found! Probing detected drivers: {', '.join(drivers_to_load)}")
            subprocess.run(["/usr/bin/modprobe", "-a"] + drivers_to_load, check=False)
        else:
            log("No network interfaces found and no specific driver identified for detected hardware.")

def main():
    log("Starting Driver Check...")
    manage_gpu_drivers()
    manage_network_drivers()
    log("Driver Check Completed.")

if __name__ == "__main__":
    main()
