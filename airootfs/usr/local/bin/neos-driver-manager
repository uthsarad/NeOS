#!/usr/bin/env python3

import os
import subprocess

def log(msg):
    print(f"[NeOS Driver Manager] {msg}")

def run_command(cmd):
    try:
        return subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT).decode().strip()
    except subprocess.CalledProcessError:
        return ""

_LOADED_MODULES_CACHE = None

def get_loaded_modules(force_refresh=False):
    global _LOADED_MODULES_CACHE
    if _LOADED_MODULES_CACHE is None or force_refresh:
        mods = run_command("lsmod")
        _LOADED_MODULES_CACHE = set()
        for line in mods.splitlines():
            parts = line.split()
            if parts:
                _LOADED_MODULES_CACHE.add(parts[0])
    return _LOADED_MODULES_CACHE

def probe_driver(module_name):
    # Try to load module and invalidate cache
    res = os.system(f"modprobe {module_name}")
    global _LOADED_MODULES_CACHE
    _LOADED_MODULES_CACHE = None
    return res

def get_pci_controllers():
    # List all VGA/3D/Display controllers
    # lspci -mn | grep -E "0300|0302|0380"
    # Class 0300: VGA compatible controller
    # Class 0302: 3D controller (often Nvidia on optimus)
    output = run_command("lspci -mn")
    devices = []
    for line in output.splitlines():
        parts = line.split()
        if len(parts) >= 3:
            # format: "00:02.0" "0300" "8086" "1916" ...
            slot = parts[0].strip('"')
            cls = parts[1].strip('"')
            vendor = parts[2].strip('"')
            device = parts[3].strip('"')
            if cls.startswith("03"): # Display controller class
                devices.append({'slot': slot, 'vendor': vendor, 'device': device})
    return devices

def check_driver_loaded(module_name):
    # Check if module is loaded using cache
    return module_name in get_loaded_modules()

def manage_gpu_drivers():
    devices = get_pci_controllers()
    if not devices:
        log("No GPU detected.")
        return

    for dev in devices:
        vendor = dev['vendor']
        log(f"Found GPU: Vendor {vendor}, Device {dev['device']}")

        # Intel (8086)
        if vendor == "8086":
            if not check_driver_loaded("i915") and not check_driver_loaded("xe"):
                log("Intel GPU detected but i915/xe not loaded.")
                # Try loading
                probe_driver("i915")

        # AMD (1002)
        elif vendor == "1002":
            if not check_driver_loaded("amdgpu"):
                log("AMD GPU detected but amdgpu not loaded.")
                # Try loading
                probe_driver("amdgpu")
                # Fallback
                if not check_driver_loaded("amdgpu"):
                    log("Retrying with radeon...")
                    probe_driver("radeon")
            else:
                log("AMD driver (amdgpu) is loaded.")

        # Nvidia (10de)
        elif vendor == "10de":
            if not check_driver_loaded("nvidia"):
                log("Nvidia GPU detected but nvidia proprietary driver not loaded.")
                res = probe_driver("nvidia")
                if res != 0:
                    log("Failed to load nvidia. Checking for nouveau (community)...")
                    if not check_driver_loaded("nouveau"):
                        probe_driver("nouveau")
            else:
                log("Nvidia driver is loaded.")

def manage_network_drivers():
    # Simple check for network interfaces
    # If no interface other than lo, try to find drivers
    output = run_command("ip link show")
    if len(output.splitlines()) <= 2: # loopback only roughly
        log("No network interfaces found! Probing common drivers...")
        # Try loading common modules just in case
        subprocess.run(["modprobe", "-a", "r8169", "e1000e", "wl", "brcmfmac", "ath10k_pci", "iwlwifi"], check=False)

def main():
    log("Starting Driver Check...")
    manage_gpu_drivers()
    manage_network_drivers()
    log("Driver Check Completed.")

if __name__ == "__main__":
    main()
