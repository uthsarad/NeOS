#!/bin/bash
# NeOS CLI - Unified system management tool
# This script provides a single entry point for common NeOS administrative tasks.

VERSION="0.1.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

function log_info() {
    echo -e "${BLUE}[NeOS]${NC} $1"
}

function log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

function log_warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

function log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

function show_help() {
    echo "NeOS CLI v$VERSION"
    echo "Usage: neos <command> [options]"
    echo ""
    echo "Commands:"
    echo "  update    - Update the system (creates snapshot before update)"
    echo "  drivers   - Check and manage system drivers"
    echo "  install   - Launch the system installer"
    echo "  fix-keys  - Refresh Pacman keys (fixes signature errors)"
    echo "  version   - Show NeOS version"
    echo "  help      - Show this help message"
}

function check_root() {
    if [ "$EUID" -ne 0 ]; then
        log_error "This command must be run as root. Please run: sudo neos $1"
        exit 1
    fi
}

# Main command dispatcher
case "$1" in
    update)
        check_root "update"
        if [ -x "/usr/local/bin/neos-autoupdate.sh" ]; then
            /usr/local/bin/neos-autoupdate.sh
        else
            log_error "Update script not found!"
            exit 1
        fi
        ;;
    drivers)
        check_root "drivers"
        if [ -x "/usr/local/bin/neos-driver-manager" ]; then
            /usr/local/bin/neos-driver-manager
        else
            log_error "Driver manager script not found!"
            exit 1
        fi
        ;;
    install)
        log_info "Launching installer..."

        # Check if running in a graphical environment
        if [ -n "$DISPLAY" ] || [ -n "$WAYLAND_DISPLAY" ]; then
            if command -v calamares &> /dev/null; then
                # If root, run directly (Calamares handles permissions internally usually, or needs sudo)
                if [ "$EUID" -eq 0 ]; then
                     calamares
                else
                     sudo -E calamares
                fi
            else
                log_warn "Calamares GUI installer not found. Falling back to CLI installer..."
                # Fallback to CLI installer
                 if command -v archinstall &> /dev/null; then
                    if [ "$EUID" -eq 0 ]; then
                        archinstall
                    else
                        sudo archinstall
                    fi
                else
                    log_error "No installer found (checked calamares and archinstall)."
                    exit 1
                fi
            fi
        else
            # CLI environment
            if command -v archinstall &> /dev/null; then
                if [ "$EUID" -eq 0 ]; then
                    archinstall
                else
                    sudo archinstall
                fi
            else
                log_error "Archinstall not found. Cannot install in CLI mode."
                exit 1
            fi
        fi
        ;;
    fix-keys)
        check_root "fix-keys"
        log_info "Refreshing Pacman keys..."
        pacman-key --init
        pacman-key --populate archlinux
        pacman-key --refresh-keys
        log_success "Pacman keys refreshed."
        ;;
    version)
        echo "NeOS CLI v$VERSION"
        if [ -f /etc/os-release ]; then
            source /etc/os-release
            echo "OS: $PRETTY_NAME"
        fi
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        show_help
        exit 1
        ;;
esac
