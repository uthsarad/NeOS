#!/bin/bash
# NeOS Live User Setup
# Creates a temporary live user for the live ISO session.
# Only runs on the live ISO (detected via /run/archiso).

# Sentinel: Error Handling - Enable strict mode
set -euo pipefail

# Only run on the live ISO
if [ ! -d /run/archiso ]; then
    exit 0
fi

# Create liveuser if it doesn't exist
if ! id liveuser &>/dev/null; then
    useradd -m -G wheel,sys,lp,network,video,optical,storage,scanner,power,adm,uucp -s /bin/bash liveuser
    passwd -d liveuser

    # Sentinel: Grant NOPASSWD only for live user in the live session
    # This ensures the installed system requires passwords for wheel users
    # Note: This file is created in the overlay and will NOT persist to installed system
    if [ -d /etc/sudoers.d ]; then
        echo "liveuser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/zz-live-wheel
        chmod 440 /etc/sudoers.d/zz-live-wheel
    fi
fi

# Sentinel: Enable passwordless sudo for live session only
# Create a temporary sudoers file in the overlay (not copied to installed system)
if [ ! -f /etc/sudoers.d/zz-live-wheel ] && [ -d /etc/sudoers.d ]; then
    echo "%wheel ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/zz-live-wheel
    chmod 440 /etc/sudoers.d/zz-live-wheel
fi
