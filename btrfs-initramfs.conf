#!/usr/bin/ash
# Initramfs hook to ensure Btrfs support is available

run_hook() {
    # Btrfs is built into the kernel, so no module loading needed
    # Just check if root device is btrfs and mount accordingly
    msg "Mounting root filesystem (${root})"
    
    # Check if root is a btrfs subvolume
    if [[ -n "${btrfs_root_subvol}" ]]; then
        modprobe btrfs 2>/dev/null
        # Wait for device to appear
        udevadm settle -t 30
        # Mount with subvolume option
        root_mount_opts="defaults,subvol=${btrfs_root_subvol},compress=zstd:3,ssd,noatime,space_cache=v2"
    else
        # Standard btrfs mount
        root_mount_opts="defaults,compress=zstd:3,ssd,noatime,space_cache=v2"
    fi
    
    # Mount the root filesystem
    if ! mount -o "${root_mount_opts}" "${root}" "${mnt}"; then
        echo "Failed to mount root filesystem ${root}"
        return 1
    fi
}